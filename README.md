# udacity_fsnd_project3 - Web Server Demo
This repository is for the 3rd project for Udacity's Full Stack Developer nanodegree program. For this project I am to create a web server hosted by Amazon Lightsail on which I will run the code from [Project 2](https://github.com/garrett-mccutcheon/udacity_fsnd_project2). This is a step-by-step guide for setting up the vanilla server to run this project, based on the requirements outlined by Udacity for this project.

# Setup
Unless otherwise specified in a particular step, all implementation steps use knowledge available from Udacity's _Configuring Linux Web Servers_ course or from my own personal experience setting up and administrating Linux machines.

## Server Initialization
### 1. Amazon Lightsail

Create a new server instance via Amazon Lightsail. This instance should run vanilla Ubuntu 16.04.

### 2. Obtain public DNS address

Using xip.io, once the server has been created by Amazon, you can use the public ip address along with the xip.io domain, to refer to your server. For example, the server used in this project is located at 3.80.130.250.xip.io

### 3. Create a non-root sudo-enabled user with ssh access
#### 3.1 Create a non-root user 'grader'
```bash
adduser grader
```

Be sure to specify a strong password, although we'll be revoking password-based login.

#### 3.2 Grant 'grader' permission to sudo
Create a new file in etc/sudoers.d/ called local
```bash
sudo touch /etc/sudoers.d/local
```

Populate this file via your preferred text editor (e.g., Vim) with the following:
```
# User alias specification
User_Alias  ADMIN = grader

# Permissions Specifications
ADMIN ALL = NOPASSWD: ALL
```
This creates a local set of permissions with a User_Alias group called ADMIN (short for "administrators") and then grants the ADMIN group the authority to run any command on any host without authenticating. Using a User_Alias makes future management easier as you only need to modify the members of the User_Alias specification without needing to modify or add permissions declarations. See [the sudoers man page](https://www.sudo.ws/man/sudoers.man.html) for more information.

#### 3.3 Set up ssh for grader
Generate an SSH key for the grader user from the grader user's local machine. For the course we are creating the grader user's ssh key ourselves, which isn't strictly 'private', however this is for grading example purposes. In a legitimate production environment we'd either already have our own key or the user we are setting up would provide their public key to us.

##### 3.3.1 Generate a key pair
From the local machine:
```bash
ssh-keygen
```
Complete the steps of the `ssh-keygen` process.

##### 3.3.2 Install the public key on the remote server
On the remote machine (our web server):
```bash
sudo su grader
mkdir ~/.ssh
touch ~/.ssh/authorized_keys
```
Copy the contents of id_rsa.pub generated by the keygen and paste the contents into the `authorized_keys` file.

##### 3.3.3 Secure the .ssh directory
Finally, we need to ensure that the .ssh directory and `authorized_keys` files are secure.
While still the grader user:
```bash
chmod 640 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

##### 3.3.4 Revoke root's ssh access
Now that we have a local non-root user with sudo permissions we no longer want users to be able to login as root via ssh as this is a potential security risk.
As grader user:
```bash
sudo vim /etc/ssh/sshd_config
```
Search for a line beginning with `PermitRootLogin` and set this line to `PermitRootLogin: no`

##### 3.3.5 Change ssh port
For additional security we will also change the ssh port to a non-default port 2200. Open `sshd_config` as we did in the previous step and find the line beginning with `Port` and change its value to be `Port 2200`.

##### 3.3.6 Restart ssh
```bash
sudo service ssh restart
```

**Note: you will now have to login via ssh using the -p flag e.g. `ssh grader@ip -p 2200`**

### 4. Configure the Uncomplicated Firewall
The final step in ensuring the safety and security of our sever is to configure the Uncomplicated Firewall (UFW) to only allow incoming connections for SSH (via port 2200), HTTP (port 80), and NTP (port 123).
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 2200/tcp
sudo ufw allow 80/tcp
sudo ufw allow 123
```

### 5. Update installed packages and install postgresql, apache2+mod_wsgi, and other project dependencies
#### 5.1 Update installed packages
```bash
sudo apt update
sudo apt upgrade
```

#### 5.2 Install postgresql
##### 5.2.1 Install
```bash
sudo apt install postgresql
```

##### 5.2.2 Configure postgresql
Create a new user named catalog with an appropriately secure password:
```bash
sudo adduser catalog
```
Create a `postgres` user for the catalog:
```bash
sudo su postgres -c 'createuser -dRS catalog'
```
Create a database `catalog` owned by the new `catalog` user:
```bash
sudo su postgres -c 'createdb catalog -O catalog'
```
Disable access for all other users and set a password for the catalog user:
```bash
sudo su postgres -c 'psql'
```
From inside the `psql` interpreter run:
```postgresql
REVOKE connect ON DATABASE catalog FROM PUBLIC;
GRANT connect ON DATABASE catalog TO catalog;
ALTER USER catalog WITH PASSWORD '<Password_Here>';
```
Be sure to replace <Password_Here> with a suitable password.
We also need to ensure that we can connect via password to our database from other applications. We'll edit `/etc/postgresql/9.5/main/pg_hba.conf` to the following:
```conf

#### 5.3 Install Apache2
##### 5.3.1 Install
```bash
sudo apt install apache2 apache2-doc
```

##### 5.3.2 Install mod_wsgi
Note that we need to install the Python3-compatible mod_wsgi as our catalog app utilizes Python3
```bash
sudo apt install libapache2-mod-wsgi-py3
```

##### 5.3.3 Configure mod_wsgi with a basic initial config
The following borrows heavily from the [mod_wsgi Quick Configuration Guide](https://modwsgi.readthedocs.io/en/develop/user-guides/quick-configuration-guide.html).
We're going to create a directory in which our WSGI scripts will reside. This separates our WSGI scripts from the applications they are executing, as well as separating them from other potention html or application directories that may be installed in /var/www/.
```bash
sudo mkdir /var/www/wsgi_scripts/
```
We'll also create a bare-bones WSGI script to verify that the WSGI module is working. Create a file named `test.wsgi` in the `/var/www/wsgi_scripts/` directory and populate it with the following:
```python
def application(environ, start_response):
  status = '200 OK'
  output = b'Hello! This is a working WSGI script!'
  
  response_headers = [('Content-type', 'text/plaint'), ('Content-length', str(len(output)))]
  start_response(status, response_headers)
  
  return [output]
```
Change the permissions of this file to allow it to be executed:
```bash
sudo chmod 655 /var/www/wsgi_cripts/test.wsgi
```
Now we need to point Apache2 to our new WSGI file and directory. First, navigate to the public IP address of your server via web browser. You should be greeted by the 'Apache2 Ubuntu Default Page' which indicates that Apache2 is up and running. Next, edit `/etc/apache2/sites-enabled/000-default.conf` and add the following inside the `<VirtualHost>` block:
```conf
WSGIScriptAlias / /var/www/wsgi_scripts/test.wsgi
```
Now restart Apache2:
```bash
sudo apache2ctl restart
```
Reload the public IP address of your server in your web browser. If you see `Hello! This is a working WSGI script!` then Apache2 is successfully running mod_wsgi and is pointed at your test.wsgi file.

#### 5.4 Install other project dependencies
Now we'll install all other project dependencies.
##### 5.4.1 Install applications
```bash
sudo apt install python3 python3-pip git pgloader
```
##### 5.4.2 Install python dependencies
```bash
sudo pip3 install --upgrade pip
sudo pip3 install sqlalchemy flask requests google-auth psycopg2
sudo pip3 install --upgrade cryptography
```

### 6. Deploy item catalog (from Project 2)
#### 6.1 Configure a directory for the catalog
Make a new directory:
```bash
sudo mkdir /var/www/catalog/
```
Change its ownership so that the catalog user and www-data group own it:
```bash
sudo chown catalog:www-data /var/www/catalog/
```
#### 6.2 Install the item catalog files
Start by cloning the item catalog into `/var/www/catalog/`:
```bash
cd /var/www/catalog/
sudo su catalog -c 'git clone https://github.com/garrett-mccutcheon/udacity_fsnd_project2.git'
```
#### 6.3 Configure the item catalog to use our PostgreSQL database
##### 6.3.1 Copy the contents of recipe_book.db into our PostgreSQL db
We'll use [PgLoader](https://pgloader.readthedocs.io/en/latest/pgloader.html) to copy the contents of the SQLite database into our PostgreSQL `catalog` database:
```bash 
sudo su catalog -c 'pgloader /var/www/catalog/udacity_fsnd_project2/recipe_book.db postgresql://catalog:<CAT_PSWD>@/catalog'
```
*Be sure to replace <CAT_PSWD> with the password set when you created the `catalog` user!*
##### 6.3.2 Modify application.py to point to this database
Edit `/var/www/catalog/udacity_fsnd_project2/appication.py` so that the `engine` variable points to our `catalog` database
```python
engine = create_engine('postgresql+psycopg2://catalog:<CAT_PSWD>@/catalog', echo=True)
```
*Once again be sure to replace <CAT_PSWD>*
#### 6.4 Configure mod_wsgi to point to this application at /catalog
##### 6.4.1 Create new wsgi file
In the `/var/www/wsgi_scripts` directory create `catalog.wsgi` and populate it with the following:
```python
#!/usr/bin/env python3
import sys

ENV = '/var/www/catalog/udacity_fsnd_project2/'

sys.path.append(ENV)
from application import app as application
```
This file tells the system that our catalog project should be part of PATH for the process executing our WSGI script, and then imports the `app` call from `application.py` as `application` as specified by the mod_wsgi docs.
Change the ownership and permissions of this file as we did with test.wsgi:
```bash
sudo chown www-data:www-data catalog.wsgi
sudo chmod 655 catalog.wsgi
```
##### 6.4.2 Point /catalog to our new wsgi script
Edit `/etc/apache2/sites_enabled/000-default.conf` and add the following inside the `<VirtualHost>` block:
```apache
WSGIScriptAlias /catalog /var/www/wsgi_scripts/catalog.wsgi
```
Restart Apache2
```bash
sudo apache2ctl restart
```
Navigate to 
